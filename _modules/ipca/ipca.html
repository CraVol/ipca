

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ipca.ipca &mdash; ipca  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> ipca
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ipca</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>ipca.ipca</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ipca.ipca</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="k">import</span> <span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">RegressorMixin</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="k">import</span> <span class="n">GroupKFold</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="k">import</span> <span class="n">ElasticNet</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="k">import</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="k">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="k">import</span> <span class="n">jit</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">progressbar</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">time</span>

<div class="viewcode-block" id="IPCARegressor"><a class="viewcode-back" href="../../index.html#ipca.IPCARegressor">[docs]</a><span class="k">class</span> <span class="nc">IPCARegressor</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class implements the IPCA algorithm by Kelly, Pruitt, Su (2017).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    n_factors : int, default=1</span>
<span class="sd">        The total number of factors to estimate. Note, the number of</span>
<span class="sd">        estimated factors is automatically reduced by the number of</span>
<span class="sd">        pre-specified factors. For example, if n_factors = 2 and one</span>
<span class="sd">        pre-specified factor is passed, then IPCARegressor will estimate</span>
<span class="sd">        one factor estimated in addition to the pre-specified factor.</span>

<span class="sd">    intercept : boolean, default=False</span>
<span class="sd">        Determines whether the model is estimated with or without an intercept</span>

<span class="sd">    max_iter : int, default=10000</span>
<span class="sd">        Maximum number of alternating least squares updates before the</span>
<span class="sd">        estimation is stopped</span>

<span class="sd">    iter_tol : float, default=10e-6</span>
<span class="sd">        Tolerance threshold for stopping the alternating least squares</span>
<span class="sd">        procedure</span>

<span class="sd">    alpha : scalar</span>
<span class="sd">        Regularizing constant for Gamma estimation.  If this is set to</span>
<span class="sd">        zero then the estimation defaults to non-regularized.</span>

<span class="sd">    l1_ratio : scalar</span>
<span class="sd">        Ratio of l1 and l2 penalties for elastic net Gamma fit.</span>

<span class="sd">    n_jobs : scalar</span>
<span class="sd">        number of jobs for F step estimation in ALS, if set to one no</span>
<span class="sd">        parallelization is done</span>

<span class="sd">    backend : str</span>
<span class="sd">        label for Joblib backend used for F step in ALS</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_factors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                 <span class="n">iter_tol</span><span class="o">=</span><span class="mf">10e-6</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;loky&quot;</span><span class="p">):</span>

        <span class="c1"># paranoid parameter checking to make it easier for users to know when</span>
        <span class="c1"># they have gone awry and to make it safe to assume some variables can</span>
        <span class="c1"># only have certain settings</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_factors</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">n_factors</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;n_factors must be an int greater / equal 1.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">intercept</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;intercept must be  boolean&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iter_tol</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="n">iter_tol</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Iteration tolerance must be smaller than 1.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">l1_ratio</span> <span class="o">&gt;</span> <span class="mf">1.</span> <span class="ow">or</span> <span class="n">l1_ratio</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;l1_ratio must be between 0 and 1&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alpha</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;alpha must be greater than or equal to 0&quot;</span><span class="p">)</span>

        <span class="c1"># Save parameters to the object</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;self&#39;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>


<div class="viewcode-block" id="IPCARegressor.fit"><a class="viewcode-back" href="../../index.html#ipca.IPCARegressor.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">PSF</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Gamma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Factors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">data_type</span><span class="o">=</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fits the regressor to the data using an alternating least squares</span>
<span class="sd">        scheme.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X :  numpy array</span>
<span class="sd">            X of stacked data. Each row corresponds to an observation</span>
<span class="sd">            (i, t) where i denotes the entity index and t denotes</span>
<span class="sd">            the time index. The panel may be unbalanced. The number of unique</span>
<span class="sd">            entities is n_samples, the number of unique dates is T, and</span>
<span class="sd">            the number of characteristics used as instruments is L.</span>
<span class="sd">            The columns of the panel are organized in the following order:</span>

<span class="sd">            - Column 1: entity id (i)</span>
<span class="sd">            - Column 2: time index (t)</span>
<span class="sd">            - Column 3 to column 3+L: characteristics.</span>

<span class="sd">        y : numpy array</span>
<span class="sd">            dependent variable where indices correspond to those in X</span>

<span class="sd">        PSF : numpy array, optional</span>
<span class="sd">            Set of pre-specified factors as matrix of dimension (M, T)</span>

<span class="sd">        Gamma : numpy array or None</span>
<span class="sd">            If provided, starting values for Gamma (see Notes)</span>

<span class="sd">        Factors : numpy array</span>
<span class="sd">            If provided, starting values for Factors (see Notes)</span>

<span class="sd">        data_type : str</span>
<span class="sd">            label for data-type used for ALS estimation, one of the following:</span>

<span class="sd">            1. panel</span>

<span class="sd">            ALS uses the untransformed X and y for the estimation.</span>

<span class="sd">            This is currently marginally slower than the portfolio estimation</span>
<span class="sd">            but is necessary when performing regularized estimation</span>
<span class="sd">            (alpha &gt; 0).</span>

<span class="sd">            2. portfolio</span>

<span class="sd">            ALS uses a matrix of characteristic weighted portfolios (Q)</span>
<span class="sd">            as well as a matrix of weights (W) and count of non-missing</span>
<span class="sd">            observations for each time period (val_obs) for the estimation.</span>

<span class="sd">            See _unpack_panel for details on how these variables are formed</span>
<span class="sd">            from the initial X and y.</span>

<span class="sd">            Currently, the bootstrap procedure is only implemented in terms</span>
<span class="sd">            of the portfolio data_type.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Updates IPCARegressor instances to include param estimates:</span>

<span class="sd">        Gamma : numpy array</span>
<span class="sd">            Array with dimensions (L, n_factors) containing the</span>
<span class="sd">            mapping between characteristics and factors loadings. If there</span>
<span class="sd">            are M many pre-specified factors in the model then the</span>
<span class="sd">            matrix returned is of dimension (L, (n_factors+M)).</span>
<span class="sd">            If an intercept is included in the model, its loadings are</span>
<span class="sd">            returned in the last column of Gamma.</span>

<span class="sd">        Factors : numpy array</span>
<span class="sd">            Array with dimensions (n_factors, T) containing the estimated</span>
<span class="sd">            factors. If pre-specified factors were passed the returned</span>
<span class="sd">            array is of dimension ((n_factors - M), T),</span>
<span class="sd">            corresponding to the n_factors - M many factors estimated on</span>
<span class="sd">            top of the pre-specified ones.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check panel input</span>
        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must pass panel input data.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># remove panel rows containing missing obs</span>
            <span class="n">non_nan_ind</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">non_nan_ind</span><span class="p">]</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">non_nan_ind</span><span class="p">]</span>

        <span class="c1"># set data_type to panel if doing regularized estimation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="s2">&quot;panel&quot;</span>

        <span class="c1"># init data dimensions</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_dimensions</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># Handle pre-specified factors</span>
        <span class="k">if</span> <span class="n">PSF</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">PSF</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Number of PSF observations must match</span>
<span class="s2">                                 number of unique dates in panel X&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_PSF</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_PSF</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_PSF</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">PSF</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_factors</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Note: The number of factors (n_factors) to be</span>
<span class="s2">                      estimated matches the number of</span>
<span class="s2">                      pre-specified factors. No additional factors</span>
<span class="s2">                      will be estimated. To estimate additional</span>
<span class="s2">                      factors increase n_factors.&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="c1">#  Treating intercept as if was a prespecified factor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_factors_eff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_factors</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">PSF</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">PSF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">PSF</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">PSF</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">PSF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_factors_eff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_factors</span>

        <span class="c1"># Check that enough features provided</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_factors_eff</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;The number of factors requested exceeds number</span>
<span class="s2">                              of features&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Determine fit case - if intercept or PSF or both use PSFcase fitting</span>
        <span class="c1"># Note PSFcase in contrast to has_PSF is only indicating</span>
        <span class="c1"># that the IPCA fitting is carried out as if PSF were passed even if</span>
        <span class="c1"># only an intercept was passed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PSFcase</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_PSF</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept</span> <span class="k">else</span> <span class="kc">False</span>

        <span class="c1"># store data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSF</span> <span class="o">=</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">PSF</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_obs</span> <span class="o">=</span> <span class="n">_unpack_panel</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="c1"># Run IPCA</span>
        <span class="n">Gamma</span><span class="p">,</span> <span class="n">Factors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_ipca</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
                                        <span class="n">W</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">val_obs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">val_obs</span><span class="p">,</span>
                                        <span class="n">PSF</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PSF</span><span class="p">,</span> <span class="n">Gamma</span><span class="o">=</span><span class="n">Gamma</span><span class="p">,</span>
                                        <span class="n">Factors</span><span class="o">=</span><span class="n">Factors</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span>
                                        <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Store estimates</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSFcase</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_PSF</span><span class="p">:</span>
                <span class="n">PSF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">PSF</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dates</span><span class="p">)))),</span>
                                     <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept</span><span class="p">:</span>
                <span class="n">PSF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dates</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">Factors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Factors</span><span class="p">,</span> <span class="n">PSF</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Factors</span> <span class="o">=</span> <span class="n">PSF</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Factors</span> <span class="o">=</span> <span class="n">Gamma</span><span class="p">,</span> <span class="n">Factors</span>

        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="IPCARegressor.fit_path"><a class="viewcode-back" href="../../index.html#ipca.IPCARegressor.fit_path">[docs]</a>    <span class="k">def</span> <span class="nf">fit_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">PSF</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha_l</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_splits</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">split_method</span><span class="o">=</span><span class="n">GroupKFold</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;loky&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit a path of elastic net fits for various regularizing constants</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X :  numpy array</span>
<span class="sd">            X of stacked data. Each row corresponds to an observation</span>
<span class="sd">            (i, t) where i denotes the entity index and t denotes</span>
<span class="sd">            the time index. The panel may be unbalanced. The number of unique</span>
<span class="sd">            entities is n_samples, the number of unique dates is T, and</span>
<span class="sd">            the number of characteristics used as instruments is L.</span>
<span class="sd">            The columns of the panel are organized in the following order:</span>

<span class="sd">            - Column 1: entity id (i)</span>
<span class="sd">            - Column 2: time index (t)</span>
<span class="sd">            - Column 3 to column 3+L: characteristics.</span>

<span class="sd">        y : numpy array</span>
<span class="sd">            dependent variable where indices correspond to those in X</span>
<span class="sd">        PSF : numpy array, optional</span>
<span class="sd">            Set of pre-specified factors as matrix of dimension (M, T)</span>
<span class="sd">        alpha_l : iterable or None</span>
<span class="sd">            list of regularizing constants to use for path</span>
<span class="sd">        n_splits : scalar</span>
<span class="sd">            number of CV partitions</span>
<span class="sd">        split_method : sklearn cross-validation generator factory</span>
<span class="sd">            method to generate CV partitions</span>
<span class="sd">        n_jobs : scalar</span>
<span class="sd">            number of jobs for parallel CV estimation</span>
<span class="sd">        backend : str</span>
<span class="sd">            label for joblib backend</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cvmse : numpy matrix</span>
<span class="sd">            array of dim (P x (C + 1)) where P is the number of reg</span>
<span class="sd">            constants and C is the number of CV partitions</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check panel input</span>
        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must pass panel input data.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># remove panel rows containing missing obs</span>
            <span class="n">non_nan_ind</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">non_nan_ind</span><span class="p">]</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">non_nan_ind</span><span class="p">]</span>

        <span class="c1"># handle data type, since we are doing regularized estimation</span>
        <span class="c1"># only the panel fit makes sense here</span>
        <span class="k">if</span> <span class="s2">&quot;data_type&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;data_type&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="s2">&quot;panel&quot;</span>
        <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;portfolio&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported data_type for fit_path: </span><span class="se">\</span>
<span class="s2">                              &#39;portfolio&#39;. Regularized estimation is only </span><span class="se">\</span>
<span class="s2">                              implemented for &#39;panel&#39; data_type currently&quot;</span><span class="p">)</span>

        <span class="c1"># init alphas</span>
        <span class="k">if</span> <span class="n">alpha_l</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alpha_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="c1"># run cross-validation</span>
        <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cvmse</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">)(</span>
                        <span class="n">delayed</span><span class="p">(</span><span class="n">_fit_cv</span><span class="p">)(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">PSF</span><span class="p">,</span> <span class="n">n_splits</span><span class="p">,</span> <span class="n">split_method</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span>
                        <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alpha_l</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cvmse</span> <span class="o">=</span> <span class="p">[</span><span class="n">_fit_cv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">PSF</span><span class="p">,</span> <span class="n">n_splits</span><span class="p">,</span> <span class="n">split_method</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span>
                             <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alpha_l</span><span class="p">]</span>

        <span class="n">cvmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">cvmse</span><span class="p">)</span>
        <span class="n">cvmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">alpha_l</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">cvmse</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">cvmse</span></div>


<div class="viewcode-block" id="IPCARegressor.predict"><a class="viewcode-back" href="../../index.html#ipca.IPCARegressor.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mean_factor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="s2">&quot;panel&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;wrapper around different data type predict methods&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;panel&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_panel</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">mean_factor</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;portfolio&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_portfolio</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">mean_factor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported data_type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">data_type</span><span class="p">)</span></div>


<div class="viewcode-block" id="IPCARegressor.predict_panel"><a class="viewcode-back" href="../../index.html#ipca.IPCARegressor.predict_panel">[docs]</a>    <span class="k">def</span> <span class="nf">predict_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mean_factor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predicts fitted values for a previously fitted regressor + panel data</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X :  numpy array</span>
<span class="sd">            X of stacked data. Each row corresponds to an observation</span>
<span class="sd">            (i, t) where i denotes the entity index and t denotes</span>
<span class="sd">            the time index. The panel may be unbalanced. If an observation</span>
<span class="sd">            contains missing data NaN will be returned. Note that the</span>
<span class="sd">            number of passed characteristics L must match the</span>
<span class="sd">            number of characteristics used when fitting the regressor.</span>
<span class="sd">            The columns of the panel are organized in the following order:</span>

<span class="sd">            - Column 1: entity id (i)</span>
<span class="sd">            - Column 2: time index (t)</span>
<span class="sd">            - Column 3 to column 3+L: characteristics.</span>

<span class="sd">        mean_factor: boolean</span>
<span class="sd">            If true, the estimated factors are averaged in the time-series</span>
<span class="sd">            before prediction.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        ypred : numpy array</span>
<span class="sd">            The length of the returned array matches the</span>
<span class="sd">            the length of data. A nan will be returned if there is missing</span>
<span class="sd">            characteristics information.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;A panel of characteristics data must be</span>
<span class="s2">                              provided.&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Cannot contain missing observations / nan</span>
<span class="s2">                              values.&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ypred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="n">mean_Factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Factors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">mean_factor</span><span class="p">:</span>
            <span class="n">ypred</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="p">)</span>\
                <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mean_Factors</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">t_i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dates</span><span class="p">):</span>
                <span class="n">ix</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">t</span><span class="p">)</span>
                <span class="n">ypred</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="p">)</span>\
                    <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Factors</span><span class="p">[:,</span> <span class="n">t_i</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">ypred</span></div>


<div class="viewcode-block" id="IPCARegressor.predict_portfolio"><a class="viewcode-back" href="../../index.html#ipca.IPCARegressor.predict_portfolio">[docs]</a>    <span class="k">def</span> <span class="nf">predict_portfolio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mean_factor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predicts fitted values for a previously fitted regressor + portfolios</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X :  numpy array</span>
<span class="sd">            X of stacked data. Each row corresponds to an observation</span>
<span class="sd">            (i, t) where i denotes the entity index and t denotes</span>
<span class="sd">            the time index. The panel may be unbalanced. If an observation</span>
<span class="sd">            contains missing data NaN will be returned. Note that the</span>
<span class="sd">            number of passed characteristics L must match the</span>
<span class="sd">            number of characteristics used when fitting the regressor.</span>
<span class="sd">            The columns of the panel are organized in the following order:</span>

<span class="sd">            - Column 1: entity id (i)</span>
<span class="sd">            - Column 2: time index (t)</span>
<span class="sd">            - Column 3 to column 3+L: characteristics.</span>

<span class="sd">        y : numpy array</span>
<span class="sd">            dependent variable where indices correspond to those in X.</span>
<span class="sd">            Needed to unwrap panel.</span>

<span class="sd">        mean_factor: boolean</span>
<span class="sd">            If true, the estimated factors are averaged in the time-series</span>
<span class="sd">            before prediction.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        Ypred : numpy array</span>
<span class="sd">            Same dimensions as a char formed portfolios (Q)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;A panel of characteristics data must be</span>
<span class="s2">                              provided.&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Cannot contain missing observations / nan</span>
<span class="s2">                              values.&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="n">Q</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">val_obs</span> <span class="o">=</span> <span class="n">_unpack_panel</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="c1"># Compute goodness of fit measures, portfolio level</span>
        <span class="n">Num_tot</span><span class="p">,</span> <span class="n">Denom_tot</span><span class="p">,</span> <span class="n">Num_pred</span><span class="p">,</span> <span class="n">Denom_pred</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">mean_factor</span><span class="p">:</span>
            <span class="n">mean_Factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Factors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">Ypred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t_i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dates</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">mean_factor</span><span class="p">:</span>
                <span class="n">ypred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t_i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mean_Factors</span><span class="p">)</span>
                <span class="n">ypred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">ypred</span><span class="p">)</span>
                <span class="n">Ypred</span><span class="p">[:,</span><span class="n">t_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ypred</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ypred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t_i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="p">)</span>\
                    <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Factors</span><span class="p">[:,</span> <span class="n">t_i</span><span class="p">])</span>
                <span class="n">Ypred</span><span class="p">[:,</span><span class="n">t_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ypred</span>

        <span class="k">return</span> <span class="n">Ypred</span></div>


<div class="viewcode-block" id="IPCARegressor.score"><a class="viewcode-back" href="../../index.html#ipca.IPCARegressor.score">[docs]</a>    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mean_factor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="s2">&quot;panel&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;generate the panel R^2&quot;&quot;&quot;</span>

        <span class="n">yhat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">mean_factor</span><span class="p">,</span> <span class="n">data_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">yhat</span><span class="p">)</span></div>


<div class="viewcode-block" id="IPCARegressor.BS_Walpha"><a class="viewcode-back" href="../../index.html#ipca.IPCARegressor.BS_Walpha">[docs]</a>    <span class="k">def</span> <span class="nf">BS_Walpha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndraws</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;loky&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bootstrap inference on the hypothesis Gamma_alpha = 0</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        ndraws  : integer, default=1000</span>
<span class="sd">            Number of bootstrap draws and re-estimations to be performed</span>

<span class="sd">        backend : optional</span>
<span class="sd">            Value is either &#39;loky&#39; or &#39;multiprocessing&#39;</span>

<span class="sd">        n_jobs  : integer</span>
<span class="sd">            Number of workers to be used. If -1, all available workers are</span>
<span class="sd">            used.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        pval : float</span>
<span class="sd">            P-value from the hypothesis test H0: Gamma_alpha=0</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bootstrap currently not supported for</span><span class="se">\</span>
<span class="s2">                              regularized estimation.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Need to fit model with intercept first.&#39;</span><span class="p">)</span>

        <span class="c1"># fail if model isn&#39;t estimated</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bootstrap can only be run on fitted model.&quot;</span><span class="p">)</span>

        <span class="c1"># Compute Walpha</span>
        <span class="n">Walpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Compute residuals</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">t_i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dates</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[:,</span> <span class="n">t_i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[:,</span> <span class="n">t_i</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t_i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="p">)</span>\
                <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Factors</span><span class="p">[:,</span> <span class="n">t_i</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting Bootstrap...&quot;</span><span class="p">)</span>
        <span class="n">Walpha_b</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">10</span><span class="p">)(</span>
            <span class="n">delayed</span><span class="p">(</span><span class="n">_BS_Walpha_sub</span><span class="p">)(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndraws</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>

        <span class="c1"># print(Walpha_b, Walpha)</span>
        <span class="n">pval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Walpha_b</span> <span class="o">&gt;</span> <span class="n">Walpha</span><span class="p">)</span><span class="o">/</span><span class="n">ndraws</span>
        <span class="k">return</span> <span class="n">pval</span></div>


<div class="viewcode-block" id="IPCARegressor.BS_Wbeta"><a class="viewcode-back" href="../../index.html#ipca.IPCARegressor.BS_Wbeta">[docs]</a>    <span class="k">def</span> <span class="nf">BS_Wbeta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">ndraws</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;loky&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test of instrument significance.</span>
<span class="sd">        Bootstrap inference on the hypothesis  l-th column of Gamma_beta = 0.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        l   : integer</span>
<span class="sd">            Position of the characteristics for which the bootstrap is to be</span>
<span class="sd">            carried out. For example, if there are 10 characteristics, l is in</span>
<span class="sd">            the range 0 to 9 (left-/right-inclusive).</span>

<span class="sd">        ndraws  : integer, default=1000</span>
<span class="sd">            Number of bootstrap draws and re-estimations to be performed</span>

<span class="sd">        n_jobs  : integer</span>
<span class="sd">            Number of workers to be used for multiprocessing.</span>
<span class="sd">            If -1, all available Workers are used.</span>

<span class="sd">        backend : optional</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        pval : float</span>
<span class="sd">            P-value from the hypothesis test H0: Gamma_alpha=0</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bootstrap currently not supported for</span><span class="se">\</span>
<span class="s2">                              regularized estimation.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSFcase</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Need to fit model without intercept first.&#39;</span><span class="p">)</span>

        <span class="c1"># fail if model isn&#39;t estimated</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bootstrap can only be run on fitted model.&quot;</span><span class="p">)</span>

        <span class="c1"># Compute Wbeta_l if l-th characteristics is set to zero</span>
        <span class="n">Wbeta_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">Wbeta_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">Wbeta_l</span><span class="p">)</span>
        <span class="c1"># Compute residuals</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t_i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dates</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[:,</span> <span class="n">t_i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[:,</span> <span class="n">t_i</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t_i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="p">)</span>\
                <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Factors</span><span class="p">[:,</span> <span class="n">t_i</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting Bootstrap...&quot;</span><span class="p">)</span>
        <span class="n">Wbeta_l_b</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">10</span><span class="p">)(</span>
            <span class="n">delayed</span><span class="p">(</span><span class="n">_BS_Wbeta_sub</span><span class="p">)(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndraws</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>

        <span class="n">pval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Wbeta_l_b</span> <span class="o">&gt;</span> <span class="n">Wbeta_l</span><span class="p">)</span><span class="o">/</span><span class="n">ndraws</span>
        <span class="c1"># print(Wbeta_l_b, Wbeta_l)</span>

        <span class="k">return</span> <span class="n">pval</span></div>


<div class="viewcode-block" id="IPCARegressor.predictOOS"><a class="viewcode-back" href="../../index.html#ipca.IPCARegressor.predictOOS">[docs]</a>    <span class="k">def</span> <span class="nf">predictOOS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mean_factor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predicts time t+1 observation using an out-of-sample design.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X :  numpy array</span>
<span class="sd">            X of stacked data. Each row corresponds to an observation</span>
<span class="sd">            (i,t) where i denotes the entity index and t denotes</span>
<span class="sd">            the time index. All data must correspond to time t, i.e. all</span>
<span class="sd">            observations occur on the same date.</span>
<span class="sd">            If an observation contains missing data NaN will be returned.</span>
<span class="sd">            Note that the number of characteristics (L) passed,</span>
<span class="sd">            has to match the number of characteristics used when fitting</span>
<span class="sd">            the regressor.</span>
<span class="sd">            The columns of the panel are organized in the following order:</span>

<span class="sd">            - Column 1: entity id (i)</span>
<span class="sd">            - Column 2: time index (t)</span>
<span class="sd">            - Column 3 to column 3+L: characteristics.</span>

<span class="sd">        y : numpy array</span>
<span class="sd">            dependent variable where indices correspond to those in X</span>

<span class="sd">        mean_factor: boolean</span>
<span class="sd">            If true, the estimated factors are averaged in the time-series</span>
<span class="sd">            before prediction.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        ypred : numpy array</span>
<span class="sd">            The length of the returned array matches the</span>
<span class="sd">            the length of data. A nan will be returned if there is missing</span>
<span class="sd">            characteristics information.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;A panel of characteristics data must be</span>
<span class="s2">                              provided.&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The panel must only have a single timestamp.&#39;</span><span class="p">)</span>

        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ypred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># Unpack the panel into Z</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span>

        <span class="c1"># Compute realized factor returns</span>
        <span class="n">Numer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">Denom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="p">)</span>
        <span class="n">Factor_OOS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Denom</span><span class="p">,</span> <span class="n">Numer</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">mean_factor</span><span class="p">:</span>
            <span class="n">ypred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="p">)</span>\
                    <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Factors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ypred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Factor_OOS</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ypred</span></div>


    <span class="k">def</span> <span class="nf">_fit_ipca</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">PSF</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">val_obs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Gamma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Factors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">data_type</span><span class="o">=</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fits the regressor to the data using alternating least squares</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        X : None or X of data.</span>

<span class="sd">                Each row corresponds to an observation (i, t).</span>
<span class="sd">                The columns are ordered in the following manner:</span>
<span class="sd">                COLUMN 1: entity id (i)</span>
<span class="sd">                COLUMN 2: time index (t)</span>
<span class="sd">                COLUMN 3 and following: L characteristics</span>

<span class="sd">        y : None or numpy array</span>
<span class="sd">            dependent variable where indices correspond to those in X</span>

<span class="sd">        PSF : None or array-like of shape (M, T), i.e.</span>
<span class="sd">            pre-specified factors</span>

<span class="sd">        Q : None or array-like of shape (L,T),</span>
<span class="sd">            i.e. characteristics weighted portfolios</span>

<span class="sd">        W : None or array_like of shape (L, L,T),</span>


<span class="sd">        val_obs: None or array-like</span>
<span class="sd">            matrix of dimension (T), containting the number of non missing</span>
<span class="sd">            observations at each point in time</span>

<span class="sd">        Gamma : numpy array or None</span>
<span class="sd">            If provided, starting values for Gamma</span>

<span class="sd">        Factors : numpy array</span>
<span class="sd">            If provided, starting values for Factors</span>

<span class="sd">        data_type : str</span>
<span class="sd">            label for method used when fitting ALS, should be one of:</span>

<span class="sd">            1. panel</span>
<span class="sd">            2. portfolio</span>

<span class="sd">        quiet   : optional, bool</span>
<span class="sd">            If true no text output will be produced</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Gamma : array-like with dimensions (L, n_factors). If there</span>
<span class="sd">            are n_prespec many pre-specified factors in the model then the</span>
<span class="sd">            matrix returned is of dimension (L, (n_factors+M)).</span>
<span class="sd">            If an intercept is included in the model, its loadings are</span>
<span class="sd">            returned in the last column of Gamma.</span>

<span class="sd">        Factors : array_like with dimensions (n_factors, T). If</span>
<span class="sd">            pre-specified factors were passed the returned matrix is</span>
<span class="sd">            of dimension ((n_factors - M), T), corresponding to the</span>
<span class="sd">            n_factors - M many factors estimated on top of the pre-</span>
<span class="sd">            specified ones.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;panel&quot;</span><span class="p">:</span>
            <span class="n">ALS_inputs</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">ALS_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ALS_fit_panel</span>
        <span class="k">elif</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;portfolio&quot;</span><span class="p">:</span>
            <span class="n">ALS_inputs</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">val_obs</span><span class="p">)</span>
            <span class="n">ALS_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ALS_fit_portfolio</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported ALS method: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">data_type</span><span class="p">)</span>

        <span class="c1"># Initialize the Alternating Least Squares Procedure</span>
        <span class="k">if</span> <span class="n">Gamma</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">Factors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Gamma_Old</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
            <span class="n">Gamma_Old</span> <span class="o">=</span> <span class="n">Gamma_Old</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_factors_eff</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_factors_eff</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_factors_eff</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">Factor_Old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Gamma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Gamma_Old</span> <span class="o">=</span> <span class="n">Gamma</span>
        <span class="k">if</span> <span class="n">Factors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Factors_Old</span> <span class="o">=</span> <span class="n">Factors</span>

        <span class="c1"># Estimation Step</span>
        <span class="n">tol_current</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span><span class="p">((</span><span class="nb">iter</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tol_current</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_tol</span><span class="p">)):</span>

            <span class="n">Gamma_New</span><span class="p">,</span> <span class="n">Factor_New</span> <span class="o">=</span> <span class="n">ALS_fit</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">,</span> <span class="o">*</span><span class="n">ALS_inputs</span><span class="p">,</span>
                                            <span class="n">PSF</span><span class="o">=</span><span class="n">PSF</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSFcase</span><span class="p">:</span>
                <span class="n">tol_current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Gamma_New</span> <span class="o">-</span> <span class="n">Gamma_Old</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tol_current_G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Gamma_New</span> <span class="o">-</span> <span class="n">Gamma_Old</span><span class="p">))</span>
                <span class="n">tol_current_F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Factor_New</span> <span class="o">-</span> <span class="n">Factor_Old</span><span class="p">))</span>
                <span class="n">tol_current</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tol_current_G</span><span class="p">,</span> <span class="n">tol_current_F</span><span class="p">)</span>

            <span class="c1"># Update factors and loadings</span>
            <span class="n">Factor_Old</span><span class="p">,</span> <span class="n">Gamma_Old</span> <span class="o">=</span> <span class="n">Factor_New</span><span class="p">,</span> <span class="n">Gamma_New</span>

            <span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Step&#39;</span><span class="p">,</span> <span class="nb">iter</span><span class="p">,</span> <span class="s1">&#39;- Aggregate Update:&#39;</span><span class="p">,</span> <span class="n">tol_current</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-- Convergence Reached --&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Gamma_New</span><span class="p">,</span> <span class="n">Factor_New</span>


    <span class="k">def</span> <span class="nf">_ALS_fit_portfolio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Gamma_Old</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">val_obs</span><span class="p">,</span> <span class="n">PSF</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alternating least squares procedure to fit params</span>

<span class="sd">        Runs using portfolio data as input</span>

<span class="sd">        The alternating least squares procedure switches back and forth</span>
<span class="sd">        between evaluating the first order conditions for Gamma_Beta, and the</span>
<span class="sd">        factors until convergence is reached. This function carries out one</span>
<span class="sd">        complete update procedure and will need to be called repeatedly using</span>
<span class="sd">        the updated Gamma&#39;s and factors as inputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span>

        <span class="k">if</span> <span class="n">PSF</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">L</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">)</span>
            <span class="n">Ktilde</span> <span class="o">=</span> <span class="n">K</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">L</span><span class="p">,</span> <span class="n">Ktilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">)</span>
            <span class="n">K_PSF</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">PSF</span><span class="p">)</span>
            <span class="n">K</span> <span class="o">=</span> <span class="n">Ktilde</span> <span class="o">-</span> <span class="n">K_PSF</span>

        <span class="c1"># ALS Step 1</span>
        <span class="k">if</span> <span class="n">K</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c1"># case with no observed factors</span>
            <span class="k">if</span> <span class="n">PSF</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">F_New</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">,</span>
                                    <span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">)(</span>
                                <span class="n">delayed</span><span class="p">(</span><span class="n">_Ft_fit_portfolio</span><span class="p">)(</span>
                                    <span class="n">Gamma_Old</span><span class="p">,</span> <span class="n">W</span><span class="p">[:,:,</span><span class="n">t</span><span class="p">],</span> <span class="n">Q</span><span class="p">[:,</span><span class="n">t</span><span class="p">])</span>
                                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
                    <span class="n">F_New</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">F_New</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">F_New</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
                        <span class="n">F_New</span><span class="p">[:,</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">_Ft_fit_portfolio</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">,</span> <span class="n">W</span><span class="p">[:,:,</span><span class="n">t</span><span class="p">],</span>
                                                       <span class="n">Q</span><span class="p">[:,</span><span class="n">t</span><span class="p">])</span>

            <span class="c1"># observed factors+latent factors case</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">F_New</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">)(</span>
                                <span class="n">delayed</span><span class="p">(</span><span class="n">_Ft_fit_PSF_portfolio</span><span class="p">)(</span>
                                    <span class="n">Gamma_Old</span><span class="p">,</span> <span class="n">W</span><span class="p">[:,:,</span><span class="n">t</span><span class="p">],</span> <span class="n">Q</span><span class="p">[:,</span><span class="n">t</span><span class="p">],</span> <span class="n">PSF</span><span class="p">[:,</span><span class="n">t</span><span class="p">],</span>
                                    <span class="n">K</span><span class="p">,</span> <span class="n">Ktilde</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
                    <span class="n">F_New</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">F_New</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">F_New</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
                        <span class="n">F_New</span><span class="p">[:,</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">_Ft_fit_PSF_portfolio</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">,</span>
                                                           <span class="n">W</span><span class="p">[:,:,</span><span class="n">t</span><span class="p">],</span> <span class="n">Q</span><span class="p">[:,</span><span class="n">t</span><span class="p">],</span>
                                                           <span class="n">PSF</span><span class="p">[:,</span><span class="n">t</span><span class="p">],</span> <span class="n">K</span><span class="p">,</span>
                                                           <span class="n">Ktilde</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">F_New</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># ALS Step 2</span>
        <span class="n">Gamma_New</span> <span class="o">=</span> <span class="n">_Gamma_fit_portfolio</span><span class="p">(</span><span class="n">F_New</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">val_obs</span><span class="p">,</span> <span class="n">PSF</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span>
                                         <span class="n">Ktilde</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

        <span class="c1"># condition checks</span>

        <span class="c1"># Enforce Orthogonality of Gamma_Beta and factors F</span>
        <span class="k">if</span> <span class="n">K</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">R1</span> <span class="o">=</span> <span class="n">_numba_chol</span><span class="p">(</span><span class="n">Gamma_New</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Gamma_New</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">R2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_numba_svd</span><span class="p">(</span><span class="n">R1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">F_New</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">F_New</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R1</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
            <span class="n">Gamma_New</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span> <span class="o">=</span> <span class="n">_numba_lstsq</span><span class="p">(</span><span class="n">Gamma_New</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                            <span class="n">R1</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R2</span><span class="p">)</span>
            <span class="n">F_New</span> <span class="o">=</span> <span class="n">_numba_solve</span><span class="p">(</span><span class="n">R2</span><span class="p">,</span> <span class="n">R1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">F_New</span><span class="p">))</span>

        <span class="c1"># Enforce sign convention for Gamma_Beta and F_New</span>
        <span class="k">if</span> <span class="n">K</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">F_New</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sg</span><span class="p">[</span><span class="n">sg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">Gamma_New</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">Gamma_New</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">],</span> <span class="n">sg</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">F_New</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">F_New</span><span class="p">,</span> <span class="n">sg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Gamma_New</span><span class="p">,</span> <span class="n">F_New</span>


    <span class="k">def</span> <span class="nf">_ALS_fit_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Gamma_Old</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">PSF</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alternating least squares procedure to fit params</span>

<span class="sd">        Runs using panel data as input</span>

<span class="sd">        The alternating least squares procedure switches back and forth</span>
<span class="sd">        between evaluating the first order conditions for Gamma_Beta, and the</span>
<span class="sd">        factors until convergence is reached. This function carries out one</span>
<span class="sd">        complete update procedure and will need to be called repeatedly using</span>
<span class="sd">        the updated Gamma&#39;s and factors as inputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dates</span>

        <span class="k">if</span> <span class="n">PSF</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">L</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">)</span>
            <span class="n">Ktilde</span> <span class="o">=</span> <span class="n">K</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">L</span><span class="p">,</span> <span class="n">Ktilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">)</span>
            <span class="n">K_PSF</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">PSF</span><span class="p">)</span>
            <span class="n">K</span> <span class="o">=</span> <span class="n">Ktilde</span> <span class="o">-</span> <span class="n">K_PSF</span>

        <span class="c1"># prep T-ind for iteration</span>
        <span class="n">Tind</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">dates</span><span class="p">[</span><span class="n">t</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">)]</span>

        <span class="c1"># ALS Step 1</span>
        <span class="k">if</span> <span class="n">K</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c1"># case with no observed factors</span>
            <span class="k">if</span> <span class="n">PSF</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">F_New</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">,</span>
                                    <span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">)(</span>
                                <span class="n">delayed</span><span class="p">(</span><span class="n">_Ft_fit_panel</span><span class="p">)(</span>
                                    <span class="n">Gamma_Old</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="n">tind</span><span class="p">,:],</span> <span class="n">y</span><span class="p">[</span><span class="n">tind</span><span class="p">])</span>
                                <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">tind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Tind</span><span class="p">))</span>
                    <span class="n">F_New</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">F_New</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">F_New</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">tind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Tind</span><span class="p">):</span>
                        <span class="n">F_New</span><span class="p">[:,</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">_Ft_fit_panel</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="n">tind</span><span class="p">,:],</span>
                                                   <span class="n">y</span><span class="p">[</span><span class="n">tind</span><span class="p">])</span>

            <span class="c1"># observed factors+latent factors case</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">F_New</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">)(</span>
                                <span class="n">delayed</span><span class="p">(</span><span class="n">_Ft_fit_PSF_panel</span><span class="p">)(</span>
                                    <span class="n">Gamma_Old</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="n">tind</span><span class="p">,:],</span> <span class="n">y</span><span class="p">[</span><span class="n">tind</span><span class="p">],</span> <span class="n">PSF</span><span class="p">[:,</span><span class="n">t</span><span class="p">],</span>
                                    <span class="n">K</span><span class="p">,</span> <span class="n">Ktilde</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">tind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Tind</span><span class="p">))</span>
                    <span class="n">F_New</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">F_New</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">F_New</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">tind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Tind</span><span class="p">):</span>
                        <span class="n">F_New</span><span class="p">[:,</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">_Ft_fit_PSF_panel</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="n">tind</span><span class="p">,:],</span>
                                                       <span class="n">y</span><span class="p">[</span><span class="n">tind</span><span class="p">],</span> <span class="n">PSF</span><span class="p">[:,</span><span class="n">t</span><span class="p">],</span> <span class="n">K</span><span class="p">,</span>
                                                       <span class="n">Ktilde</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">F_New</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># ALS Step 2</span>
        <span class="n">Gamma_New</span> <span class="o">=</span> <span class="n">_Gamma_fit_panel</span><span class="p">(</span><span class="n">F_New</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">PSF</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Ktilde</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_ratio</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># condition checks</span>

        <span class="c1"># Enforce Orthogonality of Gamma_Beta and factors F</span>
        <span class="k">if</span> <span class="n">K</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">R1</span> <span class="o">=</span> <span class="n">_numba_chol</span><span class="p">(</span><span class="n">Gamma_New</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Gamma_New</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">R2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_numba_svd</span><span class="p">(</span><span class="n">R1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">F_New</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">F_New</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R1</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
            <span class="n">Gamma_New</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span> <span class="o">=</span> <span class="n">_numba_lstsq</span><span class="p">(</span><span class="n">Gamma_New</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                            <span class="n">R1</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R2</span><span class="p">)</span>
            <span class="n">F_New</span> <span class="o">=</span> <span class="n">_numba_solve</span><span class="p">(</span><span class="n">R2</span><span class="p">,</span> <span class="n">R1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">F_New</span><span class="p">))</span>

        <span class="c1"># Enforce sign convention for Gamma_Beta and F_New</span>
        <span class="k">if</span> <span class="n">K</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">F_New</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sg</span><span class="p">[</span><span class="n">sg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">Gamma_New</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">Gamma_New</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">],</span> <span class="n">sg</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">F_New</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">F_New</span><span class="p">,</span> <span class="n">sg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Gamma_New</span><span class="p">,</span> <span class="n">F_New</span>


    <span class="k">def</span> <span class="nf">_init_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;given panel data X and y initialize the dimensions of data</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        X : X of data. Each row corresponds to an observation (i, t).</span>
<span class="sd">                The columns are ordered in the following manner:</span>
<span class="sd">                COLUMN 1: entity id (i)</span>
<span class="sd">                COLUMN 2: time index (t)</span>
<span class="sd">                COLUMN 3 and following: L characteristics</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        updates IPCARegressor instance to include dimension info for X:</span>

<span class="sd">        dates : array-like</span>
<span class="sd">            unique dates in panel</span>

<span class="sd">        ids : array-like</span>
<span class="sd">            unique ids in panel</span>

<span class="sd">        T : scalar</span>
<span class="sd">            number of time periods</span>

<span class="sd">        N : scalar</span>
<span class="sd">            number of ids</span>

<span class="sd">        L : scalar</span>
<span class="sd">            total number of characteristics</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dates</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="bp">self</span></div>


<span class="k">def</span> <span class="nf">_unpack_panel</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a stacked panel of data where each row corresponds to an</span>
<span class="sd">    observation (i, t) into a tensor of dimensions (N, L, T) where N is the</span>
<span class="sd">    number of unique entities, L is the number of characteristics and T is</span>
<span class="sd">    the number of unique dates</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    X : X of data. Each row corresponds to an observation (i, t).</span>
<span class="sd">            The columns are ordered in the following manner:</span>
<span class="sd">            COLUMN 1: entity id (i)</span>
<span class="sd">            COLUMN 2: time index (t)</span>
<span class="sd">            COLUMN 3 and following: L characteristics</span>

<span class="sd">    y : numpy array</span>
<span class="sd">        dependent variable where indices correspond to those in X</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Q: array-like</span>
<span class="sd">        matrix of dimensions (L, T), containing the characteristics</span>
<span class="sd">        weighted portfolios</span>

<span class="sd">    W: array-like</span>
<span class="sd">        matrix of dimension (L, L, T)</span>

<span class="sd">    val_obs: array-like</span>
<span class="sd">        matrix of dimension (T), containting the number of non missing</span>
<span class="sd">        observations at each point in time</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The panel dimensions are:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;n_samples:&#39;</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="s1">&#39;, L:&#39;</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="s1">&#39;, T:&#39;</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

    <span class="n">bar</span> <span class="o">=</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">maxval</span><span class="o">=</span><span class="n">T</span><span class="p">,</span>
                                  <span class="n">widgets</span><span class="o">=</span><span class="p">[</span><span class="n">progressbar</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">),</span>
                                           <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">Percentage</span><span class="p">()])</span>
    <span class="n">bar</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">L</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">val_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t_i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dates</span><span class="p">):</span>
        <span class="n">ixt</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">val_obs</span><span class="p">[</span><span class="n">t_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ixt</span><span class="p">)</span>
        <span class="c1"># Define characteristics weighted matrices</span>
        <span class="n">Q</span><span class="p">[:,</span> <span class="n">t_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">ixt</span><span class="p">,</span> <span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">ixt</span><span class="p">])</span><span class="o">/</span><span class="n">val_obs</span><span class="p">[</span><span class="n">t_i</span><span class="p">]</span>
        <span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">ixt</span><span class="p">,</span> <span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">ixt</span><span class="p">,</span> <span class="mi">2</span><span class="p">:])</span><span class="o">/</span><span class="n">val_obs</span><span class="p">[</span><span class="n">t_i</span><span class="p">]</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">t_i</span><span class="p">)</span>
    <span class="n">bar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="c1"># return portfolio data</span>
    <span class="k">return</span> <span class="n">Q</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">val_obs</span>


<span class="k">def</span> <span class="nf">_Ft_fit_portfolio</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">,</span> <span class="n">W_t</span><span class="p">,</span> <span class="n">Q_t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;helper func to parallelize F ALS fit&quot;&quot;&quot;</span>

    <span class="n">m1</span> <span class="o">=</span> <span class="n">Gamma_Old</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W_t</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">)</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">Gamma_Old</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Q_t</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">_numba_solve</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))</span>


<span class="k">def</span> <span class="nf">_Ft_fit_PSF_portfolio</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">,</span> <span class="n">W_t</span><span class="p">,</span> <span class="n">Q_t</span><span class="p">,</span> <span class="n">PSF_t</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Ktilde</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;helper func to parallelize F ALS fit with observed factors&quot;&quot;&quot;</span>

    <span class="n">m1</span> <span class="o">=</span> <span class="n">Gamma_Old</span><span class="p">[:,:</span><span class="n">K</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W_t</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">[:,:</span><span class="n">K</span><span class="p">])</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">Gamma_Old</span><span class="p">[:,:</span><span class="n">K</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Q_t</span><span class="p">)</span>
    <span class="n">m2</span> <span class="o">-=</span> <span class="n">Gamma_Old</span><span class="p">[:,:</span><span class="n">K</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W_t</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">[:,</span><span class="n">K</span><span class="p">:</span><span class="n">Ktilde</span><span class="p">])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PSF_t</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">_numba_solve</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))</span>


<span class="k">def</span> <span class="nf">_Ft_fit_panel</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">,</span> <span class="n">X_t</span><span class="p">,</span> <span class="n">y_t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;fits F_t using panel data&quot;&quot;&quot;</span>

    <span class="n">exog_t</span> <span class="o">=</span> <span class="n">X_t</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">)</span>
    <span class="n">Ft</span> <span class="o">=</span> <span class="n">_numba_lstsq</span><span class="p">(</span><span class="n">exog_t</span><span class="p">,</span> <span class="n">y_t</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">Ft</span>


<span class="k">def</span> <span class="nf">_Ft_fit_PSF_panel</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">,</span> <span class="n">X_t</span><span class="p">,</span> <span class="n">y_t</span><span class="p">,</span> <span class="n">PSF_t</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Ktilde</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;fits F_t using panel data with PSF&quot;&quot;&quot;</span>

    <span class="n">exog_t</span> <span class="o">=</span> <span class="n">X_t</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">)</span>
    <span class="n">y_t_resid</span> <span class="o">=</span> <span class="n">y_t</span> <span class="o">-</span> <span class="n">exog_t</span><span class="p">[:,</span><span class="n">K</span><span class="p">:</span><span class="n">Ktilde</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PSF_t</span><span class="p">)</span>
    <span class="n">Ft</span> <span class="o">=</span> <span class="n">_numba_lstsq</span><span class="p">(</span><span class="n">exog_t</span><span class="p">[:,:</span><span class="n">K</span><span class="p">],</span> <span class="n">y_t_resid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">Ft</span>


<span class="k">def</span> <span class="nf">_Gamma_fit_portfolio</span><span class="p">(</span><span class="n">F_New</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">val_obs</span><span class="p">,</span> <span class="n">PSF</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Ktilde</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;helper function for fitting gamma without panel&quot;&quot;&quot;</span>

    <span class="n">Numer</span> <span class="o">=</span> <span class="n">_numba_full</span><span class="p">((</span><span class="n">L</span><span class="o">*</span><span class="n">Ktilde</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">Denom</span> <span class="o">=</span> <span class="n">_numba_full</span><span class="p">((</span><span class="n">L</span><span class="o">*</span><span class="n">Ktilde</span><span class="p">,</span> <span class="n">L</span><span class="o">*</span><span class="n">Ktilde</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># no observed factors</span>
    <span class="k">if</span> <span class="n">PSF</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>

            <span class="n">Numer</span> <span class="o">+=</span> <span class="n">_numba_kron</span><span class="p">(</span><span class="n">Q</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                                 <span class="n">F_New</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>\
                                 <span class="o">*</span> <span class="n">val_obs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">Denom</span> <span class="o">+=</span> <span class="n">_numba_kron</span><span class="p">(</span><span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">],</span>
                                 <span class="n">F_New</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                                 <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">F_New</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))))</span> \
                                 <span class="o">*</span> <span class="n">val_obs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>

    <span class="c1"># observed+latent factors</span>
    <span class="k">elif</span> <span class="n">K</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
            <span class="n">Numer</span> <span class="o">+=</span> <span class="n">_numba_kron</span><span class="p">(</span><span class="n">Q</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                                 <span class="p">(</span><span class="n">F_New</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                                 <span class="n">PSF</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))))</span>\
                                 <span class="o">*</span> <span class="n">val_obs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">Denom_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">F_New</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                                   <span class="n">PSF</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))</span>
            <span class="n">Denom</span> <span class="o">+=</span> <span class="n">_numba_kron</span><span class="p">(</span><span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">],</span> <span class="n">Denom_temp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Denom_temp</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                                 <span class="o">*</span> <span class="n">val_obs</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>

    <span class="c1"># only observed factors</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
            <span class="n">Numer</span> <span class="o">+=</span> <span class="n">_numba_kron</span><span class="p">(</span><span class="n">Q</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                                 <span class="n">PSF</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>\
                                 <span class="o">*</span> <span class="n">val_obs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">Denom</span> <span class="o">+=</span> <span class="n">_numba_kron</span><span class="p">(</span><span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">],</span>
                                 <span class="n">PSF</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                                 <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PSF</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>\
                                 <span class="o">*</span> <span class="n">val_obs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>

    <span class="n">Gamma_New</span> <span class="o">=</span> <span class="n">_numba_solve</span><span class="p">(</span><span class="n">Denom</span><span class="p">,</span> <span class="n">Numer</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">L</span><span class="p">,</span> <span class="n">Ktilde</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">Gamma_New</span>


<span class="k">def</span> <span class="nf">_Gamma_fit_panel</span><span class="p">(</span><span class="n">F_New</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">PSF</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Ktilde</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;helper function for estimating vectorized Gamma with panel&quot;&quot;&quot;</span>

    <span class="c1"># join observed factors with latent factors and map to panel</span>
    <span class="k">if</span> <span class="n">PSF</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">F_New</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">F_New</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">F</span> <span class="o">=</span> <span class="n">PSF</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">F_New</span><span class="p">,</span> <span class="n">PSF</span><span class="p">))</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="c1"># interact factors and characteristics</span>
    <span class="n">ZkF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">F</span><span class="p">[</span><span class="n">k</span><span class="p">,:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ktilde</span><span class="p">)))</span>

    <span class="c1"># elastic net fit</span>
    <span class="k">if</span> <span class="n">alpha</span><span class="p">:</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">ElasticNet</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="n">l1_ratio</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ZkF</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">coef_</span>

    <span class="c1"># OLS fit</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ZkF</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">_numba_lstsq</span><span class="p">(</span><span class="n">ZkF</span><span class="p">,</span> <span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">Ktilde</span><span class="p">,</span> <span class="n">L</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">gamma</span>


<span class="k">def</span> <span class="nf">_fit_cv</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">PSF</span><span class="p">,</span> <span class="n">n_splits</span><span class="p">,</span> <span class="n">split_method</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;inner function for fit_path doing CV</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : IPCA model instance</span>
<span class="sd">        contains the params</span>
<span class="sd">    X :  numpy array</span>
<span class="sd">        X of stacked data. Each row corresponds to an observation</span>
<span class="sd">        (i, t) where i denotes the entity index and t denotes</span>
<span class="sd">        the time index. The panel may be unbalanced. The number of unique</span>
<span class="sd">        entities is n_samples, the number of unique dates is T, and</span>
<span class="sd">        the number of characteristics used as instruments is L.</span>
<span class="sd">        The columns of the panel are organized in the following order:</span>

<span class="sd">        - Column 1: entity id (i)</span>
<span class="sd">        - Column 2: time index (t)</span>
<span class="sd">        - Column 3 to column 3+L: characteristics.</span>

<span class="sd">    y : numpy array</span>
<span class="sd">        dependent variable where indices correspond to those in X</span>
<span class="sd">    PSF : numpy array, optional</span>
<span class="sd">        Set of pre-specified factors as matrix of dimension (M, T)</span>
<span class="sd">    n_splits : scalar</span>
<span class="sd">        number of CV partitions</span>
<span class="sd">    split_method : sklearn cross-validation generator factory</span>
<span class="sd">        method to generate CV partitions</span>
<span class="sd">    alpha : scalar</span>
<span class="sd">        regularizing constant for current step in elastic-net path</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mse : array</span>
<span class="sd">        array of MSEs for each CV partition</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Groups are defined by firms</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># build iterator</span>
    <span class="n">mse_l</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">split</span> <span class="o">=</span> <span class="n">split_method</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">n_splits</span><span class="p">)</span>

    <span class="n">full_tind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">split</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]):</span>

        <span class="c1"># build partitioned model</span>
        <span class="n">train_X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">train</span><span class="p">,:]</span>
        <span class="n">test_X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">test</span><span class="p">,:]</span>
        <span class="n">train_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">train</span><span class="p">]</span>
        <span class="n">test_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">test</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">PSF</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">train_PSF</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">train_tind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">train_X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">train_tind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">full_tind</span><span class="p">,</span> <span class="n">train_tind</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">train_PSF</span> <span class="o">=</span> <span class="n">PSF</span><span class="p">[:,</span><span class="n">train_tind</span><span class="p">]</span>

        <span class="c1"># init new training model</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="n">train_IPCA</span> <span class="o">=</span> <span class="n">IPCARegressor</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="n">train_IPCA</span> <span class="o">=</span> <span class="n">train_IPCA</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_X</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span> <span class="n">train_PSF</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># get MSE</span>
        <span class="n">test_pred</span> <span class="o">=</span> <span class="n">train_IPCA</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_X</span><span class="p">,</span> <span class="n">mean_factor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">test_y</span> <span class="o">-</span> <span class="n">test_pred</span><span class="p">))</span>
        <span class="n">mse</span> <span class="o">/=</span> <span class="n">test_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mse_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mse</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mse_l</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_BS_Walpha_sub</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="n">Q_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="c1"># Re-estimate unrestricted model</span>
    <span class="n">Gamma</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="n">Gamma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
                <span class="n">d_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">standard_t</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                <span class="n">d_temp</span> <span class="o">*=</span> <span class="n">d</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">high</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">)]</span>
                <span class="n">Q_b</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Gamma</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>\
                    <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Factors</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">])</span> <span class="o">+</span> <span class="n">d_temp</span>
            <span class="n">Gamma</span><span class="p">,</span> <span class="n">Factors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fit_ipca</span><span class="p">(</span><span class="n">Q</span><span class="o">=</span><span class="n">Q_b</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">,</span>
                                             <span class="n">val_obs</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">val_obs</span><span class="p">,</span>
                                             <span class="n">PSF</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">PSF</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">data_type</span><span class="o">=</span><span class="s2">&quot;portfolio&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Encountered singularity in bootstrap iteration.</span><span class="se">\</span>
<span class="s2">                           Observation discarded.&quot;</span><span class="p">)</span>
            <span class="k">pass</span>


    <span class="c1"># Compute and store Walpha_b</span>
    <span class="n">Walpha_b</span> <span class="o">=</span> <span class="n">Gamma</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Gamma</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Walpha_b</span>


<span class="k">def</span> <span class="nf">_BS_Wbeta_sub</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="n">Q_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="c1">#Modify Gamma_beta such that its l-th row is zero</span>
    <span class="n">Gamma_beta_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Gamma</span><span class="p">)</span>
    <span class="n">Gamma_beta_l</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">Gamma</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="n">Gamma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
                <span class="n">d_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">standard_t</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                <span class="n">d_temp</span> <span class="o">*=</span> <span class="n">d</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">high</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">)]</span>
                <span class="n">Q_b</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Gamma_beta_l</span><span class="p">)</span>\
                    <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Factors</span><span class="p">[:,</span> <span class="n">t</span><span class="p">])</span> <span class="o">+</span> <span class="n">d_temp</span>
            <span class="n">Gamma</span><span class="p">,</span> <span class="n">Factors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fit_ipca</span><span class="p">(</span><span class="n">Q</span><span class="o">=</span><span class="n">Q_b</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">,</span>
                                             <span class="n">val_obs</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">val_obs</span><span class="p">,</span>
                                             <span class="n">PSF</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">PSF</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">data_type</span><span class="o">=</span><span class="s2">&quot;portfolio&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Encountered singularity in bootstrap iteration.</span><span class="se">\</span>
<span class="s2">                           Observation discarded.&quot;</span><span class="p">)</span>
            <span class="k">pass</span>

    <span class="c1"># Compute and store Walpha_b</span>
    <span class="n">Wbeta_l_b</span> <span class="o">=</span> <span class="n">Gamma</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Gamma</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">Wbeta_l_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">Wbeta_l_b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Wbeta_l_b</span>


<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_numba_solve</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">m1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">m2</span><span class="p">))</span>

<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_numba_lstsq</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">m1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">m2</span><span class="p">))</span>

<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_numba_kron</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">m1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">m2</span><span class="p">))</span>

<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_numba_chol</span><span class="p">(</span><span class="n">m1</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">m1</span><span class="p">))</span>

<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_numba_svd</span><span class="p">(</span><span class="n">m1</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">m1</span><span class="p">))</span>

<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_numba_full</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Matthias Buechner

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
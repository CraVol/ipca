

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ipca.ipca &mdash; ipca  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> ipca
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ipca</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>ipca.ipca</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ipca.ipca</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">progressbar</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="k">import</span> <span class="n">jit</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="k">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>

<div class="viewcode-block" id="IPCARegressor"><a class="viewcode-back" href="../../index.html#ipca.IPCARegressor">[docs]</a><span class="k">class</span> <span class="nc">IPCARegressor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class implements the IPCA algorithm by Kelly, Pruitt, Su (2017).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    n_factors : int, default=1</span>
<span class="sd">        The number of latent factors to estimate. Note, the number of</span>
<span class="sd">        estimated factors is automatically reduced by the number of</span>
<span class="sd">        pre-specified factors. For example, if n_factors = 2 and one</span>
<span class="sd">        pre-specified factor is passed, then IPCARegressor will estimate</span>
<span class="sd">        one factor estimated in addition to the pre-specified factor.</span>

<span class="sd">    intercept : boolean, default=False</span>
<span class="sd">        Determines whether the model is estimated with or without an intercept</span>

<span class="sd">    max_iter : int, default=10000</span>
<span class="sd">        Maximum number of alternating least squares updates before the</span>
<span class="sd">        estimation is stopped</span>

<span class="sd">    iter_tol : float, default=10e-6</span>
<span class="sd">        Tolerance threshold for stopping the alternating least squares procedure</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_factors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                 <span class="n">iter_tol</span><span class="o">=</span><span class="mf">10e-6</span><span class="p">):</span>

        <span class="c1"># paranoid parameter checking to make it easier for users to know when</span>
        <span class="c1"># they have gone awry and to make it safe to assume some variables can</span>
        <span class="c1"># only have certain settings</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_factors</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">n_factors</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;n_factors must be an int greater / equal 1.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">intercept</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;intercept must be  boolean&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iter_tol</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="n">iter_tol</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Iteration tolerance must be smaller than 1.&#39;</span><span class="p">)</span>

        <span class="c1"># Save parameters to the object</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;self&#39;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

<div class="viewcode-block" id="IPCARegressor.fit"><a class="viewcode-back" href="../../index.html#ipca.IPCARegressor.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">PSF</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fits the regressor to the data using an alternating least squares</span>
<span class="sd">        scheme.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        P :  numpy array</span>
<span class="sd">            Panel of stacked data. Each row corresponds to an observation</span>
<span class="sd">            (i, t) where i denotes the entity index and t denotes</span>
<span class="sd">            the time index. The panel may be unbalanced. The number of unique</span>
<span class="sd">            entities is n_samples, the number of unique dates is n_time, and</span>
<span class="sd">            the number of characteristics used as instruments is n_characts.</span>
<span class="sd">            The columns of the panel are organized in the following order:</span>

<span class="sd">            - Column 1: entity id (i)</span>
<span class="sd">            - Column 2: time index (t)</span>
<span class="sd">            - Column 3: dependent variable corresponding to observation (i,t)</span>
<span class="sd">            - Column 4 to column 4+n_characts: characteristics.</span>

<span class="sd">        PSF : numpy array, optional</span>
<span class="sd">            Set of pre-specified factors as matrix of dimension (n_PSF, n_time)</span>

<span class="sd">        refit : boolean, optional</span>
<span class="sd">            Indicates whether the regressor should be re-fit. If set to True</span>
<span class="sd">            the function will skip unpacking the panel into a tensor and</span>
<span class="sd">            instead use the stored values from the previous fit. Note, it is</span>
<span class="sd">            still necessary to pass the previously used P.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        Gamma : numpy array</span>
<span class="sd">            Array with dimensions (n_characts, n_factors) containing the</span>
<span class="sd">            mapping between characteristics and factors loadings. If there</span>
<span class="sd">            are n_PSF many pre-specified factors in the model then the</span>
<span class="sd">            matrix returned is of dimension (n_characts, (n_factors+n_PSF)).</span>
<span class="sd">            If an intercept is included in the model, its loadings are returned</span>
<span class="sd">            in the last column of Gamma.</span>

<span class="sd">        Factors : numpy array</span>
<span class="sd">            Array with dimensions (n_factors, n_time) containing the estimated</span>
<span class="sd">            factors. If pre-specified factors were passed the returned</span>
<span class="sd">            array is of dimension ((n_factors - n_PSF), n_time),</span>
<span class="sd">            corresponding to the n_factors - n_PSF many factors estimated on</span>
<span class="sd">            top of the pre-specified ones.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check re-fitting is valied</span>
        <span class="k">if</span> <span class="n">refit</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">X</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Refit only possible after initial fit.&#39;</span><span class="p">)</span>

        <span class="c1"># Handel paenl</span>
        <span class="k">if</span> <span class="n">P</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must pass panel data.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># remove panel rows containing missing obs</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">P</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>

        <span class="c1"># Unpack the Panel</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">refit</span><span class="p">:</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">val_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_panel</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

        <span class="c1"># Handle pre-specified factors</span>
        <span class="k">if</span> <span class="n">PSF</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">PSF</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">P</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Number of PSF observations must match</span>
<span class="s2">                                 number of unique dates in panel P&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UsePreSpecFactors</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UsePreSpecFactors</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">UsePreSpecFactors</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">PSF</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_factors</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The number of factors (n_factors) to be &quot;</span>
                              <span class="s2">&quot;estimated matches, the number of &quot;</span>
                              <span class="s2">&quot;pre-specified factors. No additional factors &quot;</span>
                              <span class="s2">&quot;will be estimated. To estimate additional &quot;</span>
                              <span class="s2">&quot;factors increase n_factors.&quot;</span><span class="p">)</span>

        <span class="c1"># Handle intercept</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_factors</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Number of factors + intercept higher than</span>
<span class="s2">                                number of characteristics. Reduce number of</span>
<span class="s2">                                factors or set intercept to false.&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="c1">#  Treating intercept it as a prespecified factor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_factors_eff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_factors</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">PSF</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">PSF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">PSF</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">PSF</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">PSF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_factors_eff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_factors</span>

        <span class="c1"># Check enough features provided</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_factors_eff</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The number of factors requested exceeds number of features&#39;</span><span class="p">)</span>

        <span class="c1"># Determine fit case - if intercept or PSF or both use PSFcase fitting</span>
        <span class="c1"># Note PSFcase in contrast to UsePreSpecFactors is only indicating</span>
        <span class="c1"># that the IPCA fitting is carried out as if PSF were passed even if</span>
        <span class="c1"># only an intercept was passed.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">UsePreSpecFactors</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PSFcase</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PSFcase</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Run IPCA</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">refit</span><span class="p">:</span>
            <span class="n">Gamma</span><span class="p">,</span> <span class="n">Factors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_ipca</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">W</span><span class="p">,</span> <span class="n">PSF</span><span class="o">=</span><span class="n">PSF</span><span class="p">,</span>
                                            <span class="n">val_obs</span><span class="o">=</span><span class="n">val_obs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Gamma</span><span class="p">,</span> <span class="n">Factors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_ipca</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">PSF</span><span class="o">=</span><span class="n">PSF</span><span class="p">,</span>
                                            <span class="n">val_obs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">val_obs</span><span class="p">)</span>

        <span class="c1"># Store estimates</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSFcase</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">UsePreSpecFactors</span><span class="p">:</span>
                <span class="n">PSF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">PSF</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dates</span><span class="p">)))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept</span><span class="p">:</span>
                <span class="n">PSF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dates</span><span class="p">)))</span>

            <span class="n">Factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Factors</span><span class="p">,</span> <span class="n">PSF</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Gamma_Est</span> <span class="o">=</span> <span class="n">Gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Factors_Est</span> <span class="o">=</span> <span class="n">Factors</span>


        <span class="c1"># Save unpacked panel for Re-fitting</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">refit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PSF</span> <span class="o">=</span> <span class="n">PSF</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val_obs</span> <span class="o">=</span> <span class="n">val_obs</span>

        <span class="c1"># Compute Goodness of Fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2_total</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2_pred</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2_total_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2_pred_x</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_R2_comps</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Gamma_Est</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Factors_Est</span></div>

<div class="viewcode-block" id="IPCARegressor.predict"><a class="viewcode-back" href="../../index.html#ipca.IPCARegressor.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mean_factor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predicts fitted values for a previously fitted regressor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        P :  numpy array</span>
<span class="sd">            Panel of stacked data. Each row corresponds to an observation</span>
<span class="sd">            (i, t) where i denotes the entity index and t denotes</span>
<span class="sd">            the time index. The panel may be unbalanced. If an observation</span>
<span class="sd">            contains missing data NaN will be returned. Note that the</span>
<span class="sd">            number of passed characteristics n_characts must match the</span>
<span class="sd">            number of characteristics used when fitting the regressor.</span>
<span class="sd">            The columns of the panel are organized in the following order:</span>

<span class="sd">            - Column 1: entity id (i)</span>
<span class="sd">            - Column 2: time index (t)</span>
<span class="sd">            - Column 3 to column 3+n_characts: characteristics.</span>

<span class="sd">        mean_factor: boolean</span>
<span class="sd">            If true, the estimated factors are averaged in the time-series</span>
<span class="sd">            before prediction.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        Ypred : numpy array</span>
<span class="sd">            The length of the returned array matches the</span>
<span class="sd">            the length of data. A nan will be returned if there is missing</span>
<span class="sd">            characteristics information.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">P</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;A panel of characteristics data must be provided.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">P</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot contain missing observations / nan values.&#39;</span><span class="p">)</span>
        <span class="n">n_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Ypred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_obs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="n">mean_Factors_Est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Factors_Est</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">mean_factor</span><span class="p">:</span>
            <span class="n">Ypred</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">P</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma_Est</span><span class="p">)</span>\
                <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mean_Factors_Est</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">t_i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dates</span><span class="p">):</span>
                <span class="n">ix</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">t</span><span class="p">)</span>
                <span class="n">Ypred</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma_Est</span><span class="p">)</span>\
                    <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Factors_Est</span><span class="p">[:,</span> <span class="n">t_i</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">Ypred</span></div>

<div class="viewcode-block" id="IPCARegressor.BS_Walpha"><a class="viewcode-back" href="../../index.html#ipca.IPCARegressor.BS_Walpha">[docs]</a>    <span class="k">def</span> <span class="nf">BS_Walpha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndraws</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;loky&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bootstrap inference on the hypotheses Gamma_alpha = 0</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        ndraws  : integer, default=1000</span>
<span class="sd">            Number of bootstrap draws and re-estiamtions to be performed</span>

<span class="sd">        backend : optional,</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        pval : float</span>
<span class="sd">            P-value from the hypothesis test H0: Gamma_alpha=0</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Need to fit model with intercept first.&#39;</span><span class="p">)</span>

        <span class="c1"># Compute Walpha</span>
        <span class="n">Walpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Gamma_Est</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma_Est</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>

        <span class="c1"># Compute residuals</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">t_i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dates</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[:,</span> <span class="n">t_i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span> <span class="n">t_i</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t_i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma_Est</span><span class="p">)</span>\
                <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Factors_Est</span><span class="p">[:,</span> <span class="n">t_i</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting Bootstrap...&quot;</span><span class="p">)</span>
        <span class="n">Walpha_b</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">10</span><span class="p">)(</span>
            <span class="n">delayed</span><span class="p">(</span><span class="n">_BS_Walpha_sub</span><span class="p">)(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndraws</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>

        <span class="c1"># print(Walpha_b, Walpha)</span>
        <span class="n">pval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Walpha_b</span> <span class="o">&gt;</span> <span class="n">Walpha</span><span class="p">)</span><span class="o">/</span><span class="n">ndraws</span>
        <span class="k">return</span> <span class="n">pval</span></div>

<div class="viewcode-block" id="IPCARegressor.predictOOS"><a class="viewcode-back" href="../../index.html#ipca.IPCARegressor.predictOOS">[docs]</a>    <span class="k">def</span> <span class="nf">predictOOS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mean_factor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predicts time t+1 observation using an out-of-sample design.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        P :  numpy array</span>
<span class="sd">            Panel of stacked data. Each row corresponds to an observation</span>
<span class="sd">            (i,t) where i denotes the entity index and t denotes</span>
<span class="sd">            the time index. All data must correspond to time t, i.e. all</span>
<span class="sd">            observations occur on the same date.</span>
<span class="sd">            If an observation contains missing data NaN will be returned.</span>
<span class="sd">            Note that the number of characteristics (n_characts) passed,</span>
<span class="sd">            has to match the number of characteristics used when fitting</span>
<span class="sd">            the regressor.</span>
<span class="sd">            The columns of the panel are organized in the following order:</span>

<span class="sd">            - Column 1: entity id (i)</span>
<span class="sd">            - Column 2: time index (t)</span>
<span class="sd">            - Column 3: dependent variable corresponding to observation (i,t)</span>
<span class="sd">            - Column 4 to column 4+n_characts: characteristics.</span>

<span class="sd">        mean_factor: boolean</span>
<span class="sd">            If true, the estimated factors are averaged in the time-series</span>
<span class="sd">            before prediction.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        Ypred : numpy array</span>
<span class="sd">            The length of the returned array matches the</span>
<span class="sd">            the length of data. A nan will be returned if there is missing</span>
<span class="sd">            characteristics information.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">P</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;A panel of characteristics data must be provided.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">P</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The panel must only have a single timestamp.&#39;</span><span class="p">)</span>

        <span class="n">n_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Ypred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_obs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># Unpack the panel into Z, Y</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">P</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">P</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Compute realized factor returns</span>
        <span class="n">Numer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Gamma_Est</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
        <span class="n">Denom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Gamma_Est</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma_Est</span><span class="p">)</span>
        <span class="n">Factor_OOS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Denom</span><span class="p">,</span> <span class="n">Numer</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">mean_factor</span><span class="p">:</span>
            <span class="n">Ypred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma_Est</span><span class="p">)</span>\
                    <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Factors_Est</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Ypred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma_Est</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Factor_OOS</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">Ypred</span></div>

    <span class="k">def</span> <span class="nf">_fit_ipca</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">val_obs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">PSF</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fits the regressor to the data using an alternating least squares</span>
<span class="sd">        scheme.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : array-like of shape (n_characts,n_time),</span>
<span class="sd">            i.e. characteristics weighted portfolios</span>

<span class="sd">        W : array_like of shape (n_characts, n_characts,n_time),</span>

<span class="sd">        nan_mask : array, boolean</span>
<span class="sd">            The value at nan_mask[n,t] is True if no nan values are contained</span>
<span class="sd">            in Z[n,:,t] or Y[n,t] and False otherwise.</span>

<span class="sd">        PSF : optional, array-like of shape (n_PSF, n_time), i.e.</span>
<span class="sd">            pre-specified factors</span>

<span class="sd">        quiet   : optional, bool</span>
<span class="sd">            If true no text output will be produced</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Gamma : array-like with dimensions (n_characts, n_factors). If there</span>
<span class="sd">            are n_prespec many pre-specified factors in the model then the</span>
<span class="sd">            matrix returned is of dimension (n_characts, (n_factors+n_PSF)).</span>
<span class="sd">            If an intercept is included in the model, its loadings are returned</span>
<span class="sd">            in the last column of Gamma.</span>

<span class="sd">        Factors : array_like with dimensions (n_factors, n_time). If</span>
<span class="sd">            pre-specified factors were passed the returned matrix is</span>
<span class="sd">            of dimension ((n_factors - n_PSF), n_time), corresponding to the</span>
<span class="sd">            n_factors - n_PSF many factors estimated on top of the pre-</span>
<span class="sd">            specified ones.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Initialize the Alternating Least Squares Procedure</span>
        <span class="n">Gamma_Old</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">Gamma_Old</span> <span class="o">=</span> <span class="n">Gamma_Old</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_factors_eff</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_factors_eff</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_factors_eff</span><span class="p">]</span>
        <span class="n">Factor_Old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># Estimation Step</span>
        <span class="n">tol_current</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>


        <span class="k">while</span><span class="p">((</span><span class="nb">iter</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tol_current</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_tol</span><span class="p">)):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSFcase</span><span class="p">:</span>
                <span class="n">Gamma_New</span><span class="p">,</span> <span class="n">Factor_New</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ALS_fit</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span>
                                                      <span class="n">val_obs</span><span class="p">,</span> <span class="n">PSF</span><span class="o">=</span><span class="n">PSF</span><span class="p">)</span>
                <span class="n">tol_current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Gamma_New</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                                      <span class="o">-</span> <span class="n">Gamma_Old</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Gamma_New</span><span class="p">,</span> <span class="n">Factor_New</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ALS_fit</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span>
                                                      <span class="n">val_obs</span><span class="p">)</span>
                <span class="n">tol_current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Gamma_New</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                                      <span class="o">-</span> <span class="n">Gamma_Old</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                                      <span class="n">Factor_New</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                                      <span class="o">-</span> <span class="n">Factor_Old</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))))</span>

            <span class="c1"># Compute update size</span>
            <span class="n">Factor_Old</span> <span class="o">=</span> <span class="n">Factor_New</span>
            <span class="n">Gamma_Old</span> <span class="o">=</span> <span class="n">Gamma_New</span>


            <span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Step&#39;</span><span class="p">,</span> <span class="nb">iter</span><span class="p">,</span> <span class="s1">&#39;- Aggregate Update:&#39;</span><span class="p">,</span> <span class="n">tol_current</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-- Convergence Reached --&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Gamma_New</span><span class="p">,</span> <span class="n">Factor_New</span>


    <span class="k">def</span> <span class="nf">_ALS_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Gamma_Old</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">val_obs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The alternating least squares procedure switches back and forth</span>
<span class="sd">        between evaluating the first order conditions for Gamma_Beta, and the</span>
<span class="sd">        factors until convergence is reached. This function carries out one</span>
<span class="sd">        complete update procedure and will need to be called repeatedly using</span>
<span class="sd">        the updated Gamma&#39;s and factors as inputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Determine whether any per-specified factors were passed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSFcase</span><span class="p">:</span>
            <span class="n">PSF</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PSF&quot;</span><span class="p">)</span>
            <span class="n">K_PSF</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">PSF</span><span class="p">)</span>

        <span class="c1"># Determine number of factors to be estimated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSFcase</span><span class="p">:</span>
            <span class="n">L</span><span class="p">,</span> <span class="n">Ktilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">)</span>
            <span class="n">K</span> <span class="o">=</span> <span class="n">Ktilde</span> <span class="o">-</span> <span class="n">K_PSF</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">L</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">)</span>
            <span class="n">Ktilde</span> <span class="o">=</span> <span class="n">K</span>

        <span class="c1"># ALS Step 1</span>
        <span class="n">F_New</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="n">K</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSFcase</span><span class="p">:</span>
                <span class="n">F_New</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
                    <span class="n">m1</span> <span class="o">=</span> <span class="n">Gamma_Old</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">])</span>\
                        <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">])</span>
                    <span class="n">m2</span> <span class="o">=</span> <span class="n">Gamma_Old</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">t</span><span class="p">])</span><span class="o">-</span><span class="n">Gamma_Old</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>\
                        <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">[:,</span> <span class="n">K</span><span class="p">:</span><span class="n">Ktilde</span><span class="p">])</span>\
                        <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PSF</span><span class="p">[:,</span> <span class="n">t</span><span class="p">])</span>
                    <span class="n">F_New</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_numba_solve</span><span class="p">(</span>
                                                    <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">F_New</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
                    <span class="n">m1</span> <span class="o">=</span> <span class="n">Gamma_Old</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Gamma_Old</span><span class="p">)</span>
                    <span class="n">m2</span> <span class="o">=</span> <span class="n">Gamma_Old</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">t</span><span class="p">])</span>
                    <span class="n">F_New</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_numba_solve</span><span class="p">(</span>
                                                    <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">F_New</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>


        <span class="c1"># ALS Step 2</span>
        <span class="n">Numer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numba_full</span><span class="p">((</span><span class="n">L</span><span class="o">*</span><span class="n">Ktilde</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">Denom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numba_full</span><span class="p">((</span><span class="n">L</span><span class="o">*</span><span class="n">Ktilde</span><span class="p">,</span> <span class="n">L</span><span class="o">*</span><span class="n">Ktilde</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="c1">#t1 = time.time()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSFcase</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">K</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
                    <span class="n">Numer</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numba_kron</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                                            <span class="p">(</span><span class="n">F_New</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                                             <span class="n">PSF</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))))</span>\
                                             <span class="o">*</span> <span class="n">val_obs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                    <span class="n">Denom_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">F_New</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                                           <span class="n">PSF</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))</span>
                    <span class="n">Denom</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numba_kron</span><span class="p">(</span><span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">],</span> <span class="n">Denom_temp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Denom_temp</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                                              <span class="o">*</span> <span class="n">val_obs</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
                    <span class="n">Numer</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numba_kron</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                                              <span class="n">PSF</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>\
                                              <span class="o">*</span> <span class="n">val_obs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                    <span class="n">Denom</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numba_kron</span><span class="p">(</span><span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">],</span>
                                              <span class="n">PSF</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                                              <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PSF</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="o">*</span> <span class="n">val_obs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>

                <span class="n">Numer</span> <span class="o">=</span> <span class="n">Numer</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numba_kron</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                                          <span class="n">F_New</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>\
                                          <span class="o">*</span> <span class="n">val_obs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                <span class="n">Denom</span> <span class="o">=</span> <span class="n">Denom</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numba_kron</span><span class="p">(</span><span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">],</span>
                                          <span class="n">F_New</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                                          <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">F_New</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))))</span> \
                                          <span class="o">*</span> <span class="n">val_obs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>

        <span class="n">Gamma_New</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numba_solve</span><span class="p">(</span><span class="n">Denom</span><span class="p">,</span> <span class="n">Numer</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">L</span><span class="p">,</span> <span class="n">Ktilde</span><span class="p">))</span>
        <span class="c1">#print(&#39;ALS2&#39;, time.time()-t1)</span>

        <span class="c1"># Enforce Orthogonality of Gamma_Beta and factors F</span>
        <span class="k">if</span> <span class="n">K</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">R1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numba_chol</span><span class="p">(</span><span class="n">Gamma_New</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Gamma_New</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">R2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numba_svd</span><span class="p">(</span><span class="n">R1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">F_New</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">F_New</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R1</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
            <span class="n">Gamma_New</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numba_lstsq</span><span class="p">(</span><span class="n">Gamma_New</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                                 <span class="n">R1</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>\
                <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R2</span><span class="p">)</span>
            <span class="n">F_New</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numba_solve</span><span class="p">(</span><span class="n">R2</span><span class="p">,</span> <span class="n">R1</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">F_New</span><span class="p">))</span>

        <span class="c1"># Enforce sign convention for Gamma_Beta and F_New</span>
        <span class="k">if</span> <span class="n">K</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">F_New</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">sg</span><span class="p">[</span><span class="n">sg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">Gamma_New</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">Gamma_New</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">],</span> <span class="n">sg</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">F_New</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">F_New</span><span class="p">,</span> <span class="n">sg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Gamma_New</span><span class="p">,</span> <span class="n">F_New</span>

    <span class="k">def</span> <span class="nf">_unpack_panel_XY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Converts a stacked panel of data where each row corresponds to an</span>
<span class="sd">        observation (i, t) into a tensor of dimensions (N, L, T) where N is the</span>
<span class="sd">        number of unique entities, L is the number of characteristics and T is</span>
<span class="sd">        the number of unique dates</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        P: Panel of data. Each row corresponds to an observation (i, t). The</span>
<span class="sd">            columns are ordered in the following manner:</span>
<span class="sd">                COLUMN 1: entity id (i)</span>
<span class="sd">                COLUMN 2: time index (t)</span>
<span class="sd">                COLUMN 3: depdent variable Y(i,t)</span>
<span class="sd">                COLUMN 4 and following: L characteristics</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        P: array-like, tensor of dimensions (N, L, T), containing</span>
<span class="sd">            the characteristics</span>

<span class="sd">        Y: array-like, matrix of dimension, containing the dependent variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">P</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">P</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The panel dimensions are:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;n_samples:&#39;</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="s1">&#39;, n_characts:&#39;</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="s1">&#39;, n_time:&#39;</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

        <span class="n">bar</span> <span class="o">=</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">maxval</span><span class="o">=</span><span class="n">N</span><span class="p">,</span>
                                      <span class="n">widgets</span><span class="o">=</span><span class="p">[</span><span class="n">progressbar</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">),</span>
                                               <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">Percentage</span><span class="p">()])</span>

        <span class="n">bar</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n_i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
            <span class="n">ixd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">P</span><span class="p">[</span><span class="n">P</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">temp_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">T</span><span class="p">,</span> <span class="n">L</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">temp_n</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
            <span class="n">temp_n</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dates</span>
            <span class="n">temp_n</span><span class="p">[</span><span class="n">ixd</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">P</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">n</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">temp_n</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_n</span><span class="p">)</span>
            <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">n_i</span><span class="p">)</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

        <span class="c1"># Append the missing observations to create balanced panel</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">P</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
        <span class="n">nan_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">P</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">nan_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nan_mask</span><span class="p">,</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
        <span class="c1"># Reshape the panel into P (N, L, T) and Y(N, T)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">P</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:],</span> <span class="n">N</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dates</span> <span class="o">=</span> <span class="n">dates</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">nan_mask</span>

    <span class="k">def</span> <span class="nf">_unpack_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Converts a stacked panel of data where each row corresponds to an</span>
<span class="sd">        observation (i, t) into a tensor of dimensions (N, L, T) where N is the</span>
<span class="sd">        number of unique entities, L is the number of characteristics and T is</span>
<span class="sd">        the number of unique dates</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        P: Panel of data. Each row corresponds to an observation (i, t). The</span>
<span class="sd">            columns are ordered in the following manner:</span>
<span class="sd">                COLUMN 1: entity id (i)</span>
<span class="sd">                COLUMN 2: time index (t)</span>
<span class="sd">                COLUMN 3: depdent variable Y(i,t)</span>
<span class="sd">                COLUMN 4 and following: L characteristics</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        X: array-like</span>
<span class="sd">            matrix of dimensions (L, T), containing the characteristics</span>
<span class="sd">            weighted portfolios</span>

<span class="sd">        W: array-like</span>
<span class="sd">            matrix of dimension (L, L, T)</span>

<span class="sd">        val_obs: array-like</span>
<span class="sd">            matrix of dimension (T), containting the number of non missing</span>
<span class="sd">            observations at each point in time</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">P</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">P</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The panel dimensions are:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;n_samples:&#39;</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="s1">&#39;, n_characts:&#39;</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="s1">&#39;, n_time:&#39;</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

        <span class="n">bar</span> <span class="o">=</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">maxval</span><span class="o">=</span><span class="n">T</span><span class="p">,</span>
                                      <span class="n">widgets</span><span class="o">=</span><span class="p">[</span><span class="n">progressbar</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">),</span>
                                               <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">Percentage</span><span class="p">()])</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">L</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">val_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t_i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dates</span><span class="p">):</span>
            <span class="n">ixt</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">t</span><span class="p">)</span>
            <span class="n">val_obs</span><span class="p">[</span><span class="n">t_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ixt</span><span class="p">)</span>
            <span class="c1"># Define characteristics weighted matrices</span>
            <span class="n">X</span><span class="p">[:,</span> <span class="n">t_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">ixt</span><span class="p">,</span> <span class="mi">3</span><span class="p">:])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">ixt</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="n">val_obs</span><span class="p">[</span><span class="n">t_i</span><span class="p">]</span>
            <span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">ixt</span><span class="p">,</span> <span class="mi">3</span><span class="p">:])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">ixt</span><span class="p">,</span> <span class="mi">3</span><span class="p">:])</span><span class="o">/</span><span class="n">val_obs</span><span class="p">[</span><span class="n">t_i</span><span class="p">]</span>
            <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">t_i</span><span class="p">)</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

        <span class="c1"># Store panel dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dates</span> <span class="o">=</span> <span class="n">dates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">N</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">L</span>

        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">val_obs</span>

    <span class="k">def</span> <span class="nf">_R2_comps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the goodness of fit measures both at the entity level</span>
<span class="sd">        and at the managed portfolio level. Requires the estimator to be</span>
<span class="sd">        fitted previously.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        P   :   Panel of stacked data. Each row corresponds to an observation</span>
<span class="sd">                (i, t) where i denotes the entity index and t denotes</span>
<span class="sd">                the time index. The panel may be unbalanced. The number of unique</span>
<span class="sd">                entities is n_samples, the number of unique dates is n_time, and</span>
<span class="sd">                the number of characteristics used as instruments is n_characts.</span>
<span class="sd">                The columns of the panel are organized in the following order:</span>

<span class="sd">                - Column 1: entity id (i)</span>
<span class="sd">                - Column 2: time index (t)</span>
<span class="sd">                - Column 3: dependent variable corresponding to observation (i,t)</span>
<span class="sd">                - Column 4 to column 4+n_characts: characteristics.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Compute goodness of fit measures, entity level</span>
        <span class="n">Ytrue</span> <span class="o">=</span> <span class="n">P</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

        <span class="c1"># R2 Total</span>
        <span class="n">Ypred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">mean_factor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">r2_total</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">((</span><span class="n">Ypred</span><span class="o">-</span><span class="n">Ytrue</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">Ytrue</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># R2 Pred</span>
        <span class="n">Ypred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">mean_factor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">r2_pred</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">((</span><span class="n">Ypred</span><span class="o">-</span><span class="n">Ytrue</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">Ytrue</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Compute goodness of fit measures, portfolio level</span>
        <span class="n">Num_tot</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Denom_tot</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Num_pred</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Denom_pred</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">mean_Factors_Est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Factors_Est</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">t_i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dates</span><span class="p">):</span>
            <span class="n">Ytrue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span> <span class="n">t_i</span><span class="p">]</span>
            <span class="c1"># R2 Total</span>
            <span class="n">Ypred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t_i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma_Est</span><span class="p">)</span>\
                <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Factors_Est</span><span class="p">[:,</span> <span class="n">t_i</span><span class="p">])</span>
            <span class="n">Num_tot</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">Ytrue</span><span class="o">-</span><span class="n">Ypred</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">Ytrue</span><span class="o">-</span><span class="n">Ypred</span><span class="p">))</span>
            <span class="n">Denom_tot</span> <span class="o">+=</span> <span class="n">Ytrue</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ytrue</span><span class="p">)</span>

            <span class="c1"># R2 Pred</span>
            <span class="n">Ypred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t_i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma_Est</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mean_Factors_Est</span><span class="p">)</span>
            <span class="n">Ypred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">Ypred</span><span class="p">)</span>
            <span class="n">Num_pred</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">Ytrue</span><span class="o">-</span><span class="n">Ypred</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">Ytrue</span><span class="o">-</span><span class="n">Ypred</span><span class="p">))</span>
            <span class="n">Denom_pred</span> <span class="o">+=</span> <span class="n">Ytrue</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ytrue</span><span class="p">)</span>


        <span class="n">r2_total_x</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">Num_tot</span><span class="o">/</span><span class="n">Denom_tot</span>
        <span class="n">r2_pred_x</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">Num_pred</span><span class="o">/</span><span class="n">Denom_pred</span>

        <span class="k">return</span> <span class="n">r2_total</span><span class="p">,</span> <span class="n">r2_pred</span><span class="p">,</span> <span class="n">r2_total_x</span><span class="p">,</span> <span class="n">r2_pred_x</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_numba_solve</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">m1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">m2</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_numba_lstsq</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">m1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">m2</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_numba_kron</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">m1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">m2</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_numba_chol</span><span class="p">(</span><span class="n">m1</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">m1</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_numba_svd</span><span class="p">(</span><span class="n">m1</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">m1</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_numba_full</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_BS_Walpha_sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="n">X_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
        <span class="n">d_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">standard_t</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">d</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">)]</span>
        <span class="n">X_b</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Gamma_Est</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>\
            <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Factors_Est</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">])</span> <span class="o">+</span> <span class="n">d_temp</span>

    <span class="c1"># Re-estimate unrestricted model</span>
    <span class="n">Gamma</span><span class="p">,</span> <span class="n">Factors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_ipca</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X_b</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">PSF</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PSF</span><span class="p">,</span>
                                    <span class="n">val_obs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">val_obs</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Compute and store Walpha_b</span>
    <span class="n">Walpha_b</span> <span class="o">=</span> <span class="n">Gamma</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Gamma</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>

    <span class="k">return</span> <span class="n">Walpha_b</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Matthias Buechner

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>